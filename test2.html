<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Wiki Notes</title>
  <!-- Sertakan CSS dan library lain jika diperlukan -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- ‚úÖ Fix -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
  <style>
  /* --- Style Umum --- */
  body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #101418;
      color: #ffffff;
    }
    #content {
      border: 1px solid #000;
      padding: 10px;
      min-height: 150px;
      margin-top: 10px;
    }
    /* Menu & Search */
    #menu {
      margin-bottom: 20px;
    }
    #menu h1 {
      margin-top: 0;
    }
    #menu button {
      margin-bottom: 10px;
    }
    /* Search Bar di Menu */
    #searchInput {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
    }
    /* Daftar Catatan */
    #noteList {
      list-style: none;
      padding-left: 0;
    }
    #noteList li {
      padding: 8px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    #noteList li:hover {
      background: #222;
    }
    
    /* Konten Editor */
    #content a.tooltip-keyword {
      color: #3366CC !important;
      text-decoration: underline !important;
      cursor: pointer;
    }
    .invisible-box {
      background: rgba(0, 0, 0, 0.4);
      padding: 30px;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .invisible-box:hover {
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    
/* ====== MY FINISH TOOLTIP (Default Layout) ====== */
.custom-tooltip {
  cursor: pointer;
  z-index: 10;
  background: #000000;
  color: white;
  text-align: left;
  padding: 0;
  width: 340px;
  border-radius: 1px;
  display: flex;
  flex-direction: column;
  border: 1px solid #1e1d1d;
  position: relative;
}
.custom-tooltip img {
  width: 100%;
  height: 180px;
  /* Menggunakan cover agar gambar mengisi container tanpa ruang kosong,
    namun object-position diatur ke center agar bagian penting gambar tetap terlihat */
  object-fit: cover;
  object-position: center;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
}
.tooltip-text {
  padding: 15px; /* Beri ruang agar teks tidak menempel dengan frame */
  background-color: #101418;
  color: #ffffff;
  font-size: 14px;
  max-height: 140px;
  overflow: hidden;
  position: relative;
  transition: max-height 0.3s ease;
}
.tooltip-text.expanded {
  max-height: none;
}
/* Gradient fade untuk menunjukkan ada teks lanjutan */
.tooltip-text::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 20px;
  background: linear-gradient(to bottom, rgba(16,20,24,0), rgba(16,20,24,1));
  pointer-events: none;
}
.read-more {
  background: #101418;
  border: none;
  color: #c0c0c0;
  cursor: pointer;
  font-size: 14px;
  text-align: left;
  transition: background-color 0.3s ease, color 0.3s ease;
}
.read-more:hover {
  background-color: #3a3a3a;
  color: #c0c0c0;
}
.hover-text {
  color: #3366cc;
  font-weight: bold;
  cursor: pointer;
  text-decoration: underline;
  display: inline;
}
.tooltip-text p {
  transition: color 0.3s ease;
  margin: 10px;
}
.tooltip-text p a {
  color: #3366cc;
  text-decoration: underline;
}
/* ====== END MY FINISH TOOLTIP ====== */

/* ====== MY FINISH TOOLTIP LEFT (Layout Kedua) ====== */
.left-tooltip {
  display: flex;
  cursor: pointer;
  flex-direction: row;
  width: 500px;
  height: 290px;
  align-items: stretch;
  border: 1px solid #1e1d1d;
  background: #4d4c4c;
  overflow: hidden;
  transition: height 0.3s ease;
  border-radius: 2px;
}
.left-tooltip.expanded {
  height: auto;
}
/* Kelas tambahan untuk membalik urutan (untuk placement 'right') */
.left-tooltip.flipped {
  flex-direction: row-reverse;
}
.left-tooltip-image-container {
  flex: 1;
  overflow: hidden;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.left-tooltip-image-container img {
  display: block;
  width: 100%;
  height: 100%;
  /* Menggunakan cover agar tidak ada ruang kosong, 
    dan object-position diatur ke center untuk menjaga fokus gambar */
  object-fit: cover;
  object-position: center;
}
.left-tooltip-text-container {
  flex: 1;
  overflow: hidden;
  background-color: #101418;
  color: #ffffff;
  padding: 15px; /* Padding ditingkatkan */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: relative;
}
.left-tooltip-text {
  overflow: hidden;
  transition: max-height 0.3s ease;
  max-height: 290px;
}
.left-tooltip-text.expanded {
  max-height: none;
}
.left-tooltip-text p {
  margin: 10px;
  font-size: 14px;
  transition: color 0.3s ease;
}
.left-tooltip-read-more {
  background: #101418;
  border: none;
  color: #c0c0c0;
  cursor: pointer;
  font-size: 14px;
  text-align: left;
  transition: background-color 0.3s ease, color 0.3s ease;
}
.left-tooltip-read-more:hover {
  background-color: #4d4c4c;
  color: #c0c0c0;
}
.left-tooltip:not(.expanded) .left-tooltip-image-container img {
  transition: none;
}
.left-tooltip.expanded .left-tooltip-image-container img {
  transform: none;
}
.left-tooltip-hover-text {
  color: #3366cc;
  font-weight: bold;
  cursor: pointer;
  text-decoration: underline;
  display: inline;
}
.left-tooltip-text p {
  transition: color 0.3s ease;
}
.left-tooltip-text p a {
  color: #3366cc;
  text-decoration: underline;
}
.left-tooltip-text p {
  margin: 10px;
}
/* Gradient fade untuk teks di layout tooltip left */
.left-tooltip-text::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 20px;
  background: linear-gradient(to bottom, rgba(16,20,24,0), rgba(16,20,24,1));
  pointer-events: none;
}
/* ====== END MY FINISH TOOLTIP LEFT ====== */

/* MY FINISH TOOLTIP and TOOLTIP LEFT Arrow */
.tippy-box[data-theme~="custom"] {
  padding: 0 !important;
}
.tippy-box[data-theme~="custom"] .tippy-content {
  padding: 0 !important;
}
.tippy-box[data-theme~="custom"] .tippy-arrow {
  width: 16px;
  height: 8px;
}
.tippy-box[data-animation=fade][data-state=hidden] {
  opacity: 0;
}
[data-tippy-root] {
  max-width: calc(100vw - 10px);
}
.tippy-box {
  position: relative;
  background-color: #2A2A2A;
  color: #fff;
  border-radius: 4px;
  font-size: 14px;
  line-height: 1.4;
  white-space: normal;
  outline: 0;
  transition-property: transform, visibility, opacity;
}
.tippy-box[data-placement^=top] > .tippy-arrow {
  bottom: 0;
}
.tippy-box[data-placement^=top] > .tippy-arrow:before {
  bottom: -10px;
  left: 0;
  border-width: 12px 12px 0;
  border-top-color: #4d4c4c;
  transform-origin: center top;
}
.tippy-box[data-placement^=bottom] > .tippy-arrow {
  top: 0;
}
.tippy-box[data-placement^=bottom] > .tippy-arrow:before {
  top: -10px;
  left: 0;
  border-width: 0 12px 12px;
  border-bottom-color: #4d4c4c;
  transform-origin: center bottom;
}
.tippy-box[data-placement^=left] > .tippy-arrow {
  right: 0;
}
.tippy-box[data-placement^=left] > .tippy-arrow:before {
  right: -10px;
  border-width: 12px 0 12px 12px;
  border-left-color: #4d4c4c;
  transform-origin: center left;
}
.tippy-box[data-placement^=right] > .tippy-arrow {
  left: 0;
}
.tippy-box[data-placement^=right] > .tippy-arrow:before {
  left: -10px;
  border-width: 12px 12px 12px 0;
  border-right-color: #4d4c4c;
  transform-origin: center right;
}
.tippy-box[data-inertia][data-state=visible] {
  transition-timing-function: cubic-bezier(.54, 1.5, .38, 1.11);
}
.tippy-arrow {
  width: 24px;
  height: 24px;
  color: #4d4c4c;
}
.tippy-arrow:before {
  content: "";
  position: absolute;
  border-color: transparent;
  border-style: solid;
}
.tippy-content {
  position: relative;
  padding: 5px 9px;
  z-index: 1;
}
/* MY FINISH TOOLTIP and TOOLTIP LEFT Arrow */

/* ====== Aturan untuk link di dalam tooltip ====== */
.tooltip-link {
  display: block;
  width: 100%;
  color: white;
  text-decoration: none;
}
.tooltip-link:hover {
  cursor: pointer;
  color: #795CB2;
}

    /* ====== Aturan untuk area gambar (drop/paste zone) ====== */
    #imageContainer {
      border: 2px dashed #ccc;
      padding: 10px;
      text-align: center;
      margin-top: 10px;
    }
    #imageContainer.hover {
      border-color: #3366CC;
    } 
    
    /* ----- Navbar Editor ----- */
    .w3-top {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 99999;
    }
    .w3-bar .w3-button {
      padding: 16px;
    }
    .w3-bar-item input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      font-size: 16px;
      background-color: #fff;
      color: #000;
    }
    
    /* ----- Modal Judul Baru (Modern & Minimalis) ----- */
    /* Modal overlay */
    .modal {
  display: none; /* Disembunyikan secara default */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5); /* Latar belakang transparan */
}

/* Konten modal */
.modal-content {
  background-color: #101418;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 90%;
  max-width: 400px;
  border-radius: 2px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  color: #fff;
}


.search-container {
    display: flex;
    align-items: center;
    padding-right: 16px;
  }

  /* NAVBAR STYLING */
  .navbar {
    display: flex;
    background-color: #1A1F25;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 0 0 8px 8px;
  }

  .navbar-title {
    margin: 0;
    font-size: 22px;
    font-weight: bold;
    color: white;
  }

  /* SEARCH BAR */
  .navbar-right {
    display: flex;
    align-items: center;
  }

  #searchInput {
    padding: 8px 14px;
    border: 2px solid #ccc;
    border-radius: 2px;
    font-size: 14px;
    width: 230px;
    transition: 0.3s ease-in-out;
  }

  #searchInput:focus {
    border-color: #007BFF;
    outline: none;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
  }

  /* HEADER DAFTAR CATATAN */
  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 80px;
    padding: 10px 20px;
  }

  .create-page-btn {
    background-color: #101418;
    color: #795CB2 ;
    padding: 8px 14px;
    border-radius: 2px;
    border-color: #888;
    font-size: 14px;
    transition: 0.3s ease;
  }

  /* NAVBAR MODERN */
  .modern-navbar {
    display: flex;
    background-color: #1A1F25;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 0 0 8px 8px;
  }

  .navbar-left,
  .navbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ICON BUTTON */
  .icon-btn {
    color: white;
    background-color: #1A1F25;
    border: none;
    font-size: 18px;
    cursor: pointer;
    padding: 6px;
    transition: background 0.2s ease;
  }

  .icon-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* JUDUL INPUT */
  .navbar-center {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .title-label {
    font-weight: bold;
    color: white;
    font-size: 22px;
    font-weight: bold;
  }

  .title-input {
    padding: 6px 10px;
    border: 2px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    width: 200px;
    transition: 0.3s;
  }

  .title-input:focus {
    border-color: #007BFF;
    outline: none;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
  }

  /* MODERN BUTTON */
  .modern-btn {
    background-color: #1A1F25;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 2px;
    font-size: 14px;
    cursor: pointer;
    transition: 0.3s;
  }

  .modern-btn:hover {
    background-color: #262626;
  }

    /* Container untuk bagian tengah navbar (judul) */
.navbar-center {
  display: flex;
  align-items: center;
  gap: 8px; /* Jarak antara teks statis dan input */
}

/* Gaya untuk teks statis "Wiki Notes |" */
.navbar-title {
  margin: 0;
  font-size: 22px;
  font-weight: bold;
  color: white;
}

/* Gaya untuk input judul */
.title-input {
  font-size: 22px;
  font-weight: bold;
  color: white;
  background: transparent;  /* Transparan agar menyatu dengan navbar */
  border: none;             /* Tanpa border */
  outline: none;            /* Hilangkan garis fokus default */
  width: auto;              /* Lebar bisa disesuaikan, misal: auto atau tetap */
}

#noteList { list-style: none; padding: 0; }
    #noteList li { margin: 8px 0; display: flex; align-items: center; }
    #noteList li a { 
    flex-grow: 1; 
    text-decoration: none; 
    font-weight: bold; /* Tambahkan ini */
}

    .delete-btn{
      background: #3b3535;
      color: white;
      border: none;
      padding: 2px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .delete-btn:hover {
      background: #000;
    }

        /* Sembunyikan tombol delete sampai hover */
        #noteList li .delete-btn {
      display: none;
    }
    #noteList li:hover .delete-btn {
      display: inline-block;
    }
    /* Modal Styling */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #101418;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }
    .modal-content h3 {
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 10px;
    }
    .modal-content p {
      font-size: 14px;
      color: #555;
      margin-bottom: 15px;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      border: 1px solid #888;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .modal-buttons {
      text-align: right;
    }
    .modal-buttons button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
      margin-left: 8px;
      font-size: 14px;
    }
    .modal-buttons button:hover {
      background: #0056b3;
    }

          /* Modal Styling */
          .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      cursor: pointer;
      color: #888;
    }
    .modal p { margin: 10px 0; }
    .modal-buttons { margin-top: 15px; text-align: right; }
    .modal-buttons button { margin-left: 8px; padding: 6px 12px; }
  </style>
</head>
<body>

  <!-- MENU -->
  <div id="menu">
    <div class="w3-top">
      <div class="w3-bar w3-card navbar">
        <div class="navbar-left">
          <h1 class="navbar-title">Wiki Notes</h1>
          <input type="text" id="searchInput" autocomplete="off" placeholder="Cari catatan..." onkeyup="searchNotes()">
        </div>
      </div>
    </div>
    <div class="note-header" style="margin-top:70px;">
      <h2>üìú Daftar Catatan</h2>
      <button class="w3-button create-page-btn" onclick="showTitleModal()">üìù Make a Page</button>
    </div>
    <ul id="noteList"></ul>
  </div>

  <!-- EDITOR -->
  <div id="editor" style="display: none; margin-top:70px;">
    <div class="w3-top">
      <div class="w3-bar w3-card modern-navbar">
        <div class="navbar-left">
          <button class="icon-btn" onclick="backToMenu()"><i class="fa fa-arrow-left"></i></button>
          <button class="icon-btn" onclick="deleteNote()"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div class="navbar-center">
          <span class="title-label">Wiki Notes:</span>
          <input type="text" id="noteTitle" placeholder="Masukkan Judul..." class="title-input">
        </div>
        <div class="navbar-right">
          <button class="icon-btn" onclick="saveNote()"><i class="fa fa-file"></i></button>
          <button class="modern-btn" onclick="setPassword()">Set Password</button>
          <button class="icon-btn" id="toggleLockButton" onclick="toggleLock()"><i class="fas fa-lock"></i></button>
          <button class="icon-btn" id="toggleAutoSaveButton" onclick="toggleAutoSave()">AutoSave: On</button>
        </div>
      </div>
    </div>
    <div id="titleWarning" style="margin-top:70px; text-align:center;">Mohon isi judul terlebih dahulu untuk menyimpan.</div>
    <br><br><br><br>
    <div id="content" class="invisible-box" contenteditable="false" style="margin-top:20px;">Tulis sesuatu...</div>
    <div id="imageContainer">
      <input type="file" id="noteImage" accept="image/*" />
      <br />
      <img id="noteImagePreview" style="max-width:200px; margin-top:10px; display:none;" alt="Preview Image">
      <br />
      <button id="deleteImage" style="display: none;" onclick="deleteImageFunc()">Hapus Gambar</button>
      <p style="font-size: 12px; color: #666;">Drag-and-drop atau paste gambar di area ini</p>
    </div>
  </div>

  <!-- MODAL BUAT JUDUL -->
  <div id="titleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTitleModal()">&times;</span>
      <h3>Bikin Judul</h3>
      <input id="modalTitleInput" type="text" autocomplete="off" placeholder="Masukkan Judul...">
      <div class="modal-buttons">
        <button onclick="saveTitleModal()">Simpan Judul</button>
      </div>
    </div>
  </div>

  <!-- MODAL SET PASSWORD -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePasswordModal()">&times;</span>
      <h3>Set Password</h3>
      <p>Set password agar tidak ada yang bisa mengedit password mu</p>
      <input id="passwordInput" type="password" autocomplete="new-password" placeholder="Masukkan password">
      <div class="modal-buttons">
        <button onclick="savePasswordModal()">Set Password</button>
      </div>
    </div>
  </div>
  <!-- SCRIPT -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script>
    // Variabel Global
    let originalTitle = ""; // menyimpan judul asli note (sebelum diedit)
    let currentTitle = localStorage.getItem("currentTitle") || "";
    let pageTitles = [];
    // currentImageData: data URL atau URL gambar
    let currentImageData = "";
    let isNewPage = false; // Flag: true saat membuat halaman baru

    // Variabel untuk autosave
    let isAutoSaveEnabled = localStorage.getItem("autosaveEnabled") === "true";
    if (localStorage.getItem("autosaveEnabled") === null) {
      isAutoSaveEnabled = true;
      localStorage.setItem("autosaveEnabled", "true");
    }

    // Fungsi untuk meng-update tampilan tombol autosave
    function updateAutoSaveButton() {
      const btn = document.getElementById("toggleAutoSaveButton");
      btn.innerText = isAutoSaveEnabled ? "AutoSave: On" : "AutoSave: Off";
    }

    // Fungsi toggle autosave
    function toggleAutoSave() {
      isAutoSaveEnabled = !isAutoSaveEnabled;
      localStorage.setItem("autosaveEnabled", isAutoSaveEnabled.toString());
      updateAutoSaveButton();
    }

    document.addEventListener("DOMContentLoaded", function () {
      updateAutoSaveButton();
      fetchPageTitles();
      if (currentTitle) {
        loadNote(currentTitle);
      } else {
        loadNotesList();
      }
      // Inisialisasi lock untuk note yang dimuat
      initializeEditorLock();
    });

    // Ambil daftar catatan dari server
    function fetchPageTitles() {
      fetch("http://localhost:3000/notes")
        .then((res) => res.json())
        .then((data) => { pageTitles = data; });
    }

    // Fungsi: Membuat halaman baru (reset editor)
    function makePage() {
      isNewPage = true;
      originalTitle = "";
      currentTitle = "";
      localStorage.setItem("currentTitle", "");
      document.getElementById("menu").style.display = "none";
      document.getElementById("editor").style.display = "block";
      document.getElementById("noteTitle").value = "";
      document.getElementById("content").innerText = "Tulis sesuatu...";
      document.getElementById("noteImage").value = "";
      document.getElementById("noteImagePreview").style.display = "none";
      currentImageData = "";
      document.getElementById("titleWarning").style.display = "block";
      document.getElementById("deleteImage").style.display = "none";
      // Inisialisasi lock untuk halaman baru (default terkunci)
      initializeEditorLock();
      // Jika halaman baru dan password belum diset, tampilkan modal set password
      setTimeout(function(){
        if (!localStorage.getItem("editorPassword_" + currentTitle)) {
          showPasswordModal();
        }
      }, 500);
    }

    // Fungsi: Kembali ke menu dan tampilkan daftar catatan
    function backToMenu() {
      document.getElementById("menu").style.display = "block";
      document.getElementById("editor").style.display = "none";
      localStorage.removeItem("currentTitle");
      loadNotesList();
    }

    // Fungsi: Memuat catatan (untuk edit) berdasarkan judul
    function loadNote(title) {
      isNewPage = false;
      originalTitle = title;
      currentTitle = title;
      localStorage.setItem("currentTitle", title);
      document.getElementById("menu").style.display = "none";
      document.getElementById("editor").style.display = "block";
      document.getElementById("noteTitle").value = title;
      document.getElementById("titleWarning").style.display = "none";
      fetch(`http://localhost:3000/notes/${title}`)
        .then((res) => res.json())
        .then((data) => {
          document.getElementById("content").innerHTML = detectTooltips(data.content);
          if (data.image) {
            currentImageData = data.image;
            const preview = document.getElementById("noteImagePreview");
            preview.src = currentImageData;
            preview.style.display = "block";
            document.getElementById("deleteImage").style.display = "inline-block";
          } else {
            currentImageData = "";
            document.getElementById("noteImagePreview").style.display = "none";
            document.getElementById("deleteImage").style.display = "none";
          }
          initializeTooltips();
          // Inisialisasi lock khusus note yang dimuat
          initializeEditorLock();
        });
    }

    // Event listener: Update judul note ketika input berubah
    document.getElementById("noteTitle").addEventListener("input", function () {
      currentTitle = this.value.trim();
      localStorage.setItem("currentTitle", currentTitle);
      if (currentTitle !== "") { document.getElementById("titleWarning").style.display = "none"; }
    });

    // Fungsi: Menyimpan catatan (dipanggil dengan tombol "Simpan")
    function saveNote() {
      const text = document.getElementById("content").innerText;
      if (currentTitle.trim() === "") {
        document.getElementById("titleWarning").style.display = "block";
        return;
      } else {
        document.getElementById("titleWarning").style.display = "none";
      }
      if (!isNewPage && originalTitle && currentTitle !== originalTitle) {
        localStorage.setItem(`note_${currentTitle}`, text);
        localStorage.setItem(`note_image_${currentTitle}`, currentImageData);
        const ratio = localStorage.getItem(`note_image_ratio_${originalTitle}`);
        if (ratio) {
          localStorage.setItem(`note_image_ratio_${currentTitle}`, ratio);
          localStorage.removeItem(`note_image_ratio_${originalTitle}`);
        }
        localStorage.removeItem(`note_${originalTitle}`);
        localStorage.removeItem(`note_image_${originalTitle}`);
        fetch(`http://localhost:3000/notes/${originalTitle}`, { method: "DELETE" })
          .then(() => {
            return fetch(`http://localhost:3000/notes/${currentTitle}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content: text, image: currentImageData })
            });
          })
          .then(() => {
            originalTitle = currentTitle;
            fetchPageTitles();
            document.getElementById("content").innerHTML = detectTooltips(text);
            initializeTooltips();
            alert("Catatan berhasil diperbarui!");
          });
      } else {
        localStorage.setItem(`note_${currentTitle}`, text);
        localStorage.setItem(`note_image_${currentTitle}`, currentImageData);
        fetch(`http://localhost:3000/notes/${currentTitle}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: text, image: currentImageData })
        }).then(() => {
          fetchPageTitles();
          document.getElementById("content").innerHTML = detectTooltips(text);
          initializeTooltips();
          alert("Catatan berhasil disimpan!");
        });
      }
    }

    // Handler untuk input file gambar
    document.getElementById("noteImage").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          currentImageData = e.target.result;
          const preview = document.getElementById("noteImagePreview");
          preview.src = currentImageData;
          preview.style.display = "block";
          document.getElementById("deleteImage").style.display = "inline-block";
          const tempImg = new Image();
          tempImg.onload = function () {
            const ratio = tempImg.naturalWidth / tempImg.naturalHeight;
            localStorage.setItem(`note_image_ratio_${currentTitle}`, ratio);
          };
          tempImg.src = currentImageData;
        };
        reader.readAsDataURL(file);
      }
    });
    
    document.getElementById("noteTitle").addEventListener("input", function () {
      currentTitle = this.value.trim();
      localStorage.setItem("currentTitle", currentTitle);
      if (currentTitle !== "") { document.getElementById("titleWarning").style.display = "none"; }
    });
    
    // Mendukung paste gambar
    document.addEventListener("paste", function (e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        let item = items[i];
        if (item.kind === "file" && item.type.indexOf("image") !== -1) {
          let blob = item.getAsFile();
          let reader = new FileReader();
          reader.onload = function (event) {
            currentImageData = event.target.result;
            const preview = document.getElementById("noteImagePreview");
            preview.src = currentImageData;
            preview.style.display = "block";
            document.getElementById("deleteImage").style.display = "inline-block";
            const tempImg = new Image();
            tempImg.onload = function () {
              const ratio = tempImg.naturalWidth / tempImg.naturalHeight;
              localStorage.setItem(`note_image_ratio_${currentTitle}`, ratio);
            };
            tempImg.src = currentImageData;
          };
          reader.readAsDataURL(blob);
        }
      }
    });
    
    // Drag-and-drop gambar
    const imageContainer = document.getElementById("imageContainer");
    if (imageContainer) {
      imageContainer.addEventListener("dragover", function (e) {
        e.preventDefault();
        imageContainer.classList.add("hover");
      });
      imageContainer.addEventListener("dragleave", function (e) {
        e.preventDefault();
        imageContainer.classList.remove("hover");
      });
      imageContainer.addEventListener("drop", function (e) {
        e.preventDefault();
        imageContainer.classList.remove("hover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type.indexOf("image") !== -1) {
            const reader = new FileReader();
            reader.onload = function (event) {
              currentImageData = event.target.result;
              const preview = document.getElementById("noteImagePreview");
              preview.src = currentImageData;
              preview.style.display = "block";
              document.getElementById("deleteImage").style.display = "inline-block";
              const tempImg = new Image();
              tempImg.onload = function () {
                const ratio = tempImg.naturalWidth / tempImg.naturalHeight;
                localStorage.setItem(`note_image_ratio_${currentTitle}`, ratio);
                scheduleAutoSave();
              };
              tempImg.src = currentImageData;
            };
            reader.readAsDataURL(file);
          }
        }
      });
    }
    
    // Hapus gambar
    function deleteImageFunc() {
      currentImageData = "";
      document.getElementById("noteImagePreview").style.display = "none";
      document.getElementById("noteImage").value = "";
      document.getElementById("deleteImage").style.display = "none";
      scheduleAutoSave();
    }
    
    // Fungsi untuk menampilkan daftar catatan di halaman utama (menu)
    function loadNotesList() {
      fetch("http://localhost:3000/notes")
        .then((res) => res.json())
        .then((data) => {
          const list = document.getElementById("noteList");
          list.innerHTML = "";
          data.forEach((title) => {
            const li = document.createElement("li");
            // Tautan untuk membuka note dan tombol delete (muncul saat hover)
            li.innerHTML = `<a href="#" onclick="loadNote('${title}')">${title}</a>
                            <button class="delete-btn" onclick="deleteNoteDirect('${title}')">Delete</button>`;
            list.appendChild(li);
          });
        });
    }
    
    // Fungsi baru: Menghapus catatan langsung dari daftar (tanpa membuka note)
    function deleteNoteDirect(noteTitle) {
      const confirmDelete = confirm(`Yakin mau hapus catatan "${noteTitle}"?`);
      if (!confirmDelete) return;
      localStorage.removeItem(`note_${noteTitle}`);
      localStorage.removeItem(`note_image_${noteTitle}`);
      localStorage.removeItem("editorLocked_" + noteTitle);
      localStorage.removeItem("editorPassword_" + noteTitle);
      fetch(`http://localhost:3000/notes/${noteTitle}`, { method: "DELETE" })
        .then(() => {
          alert(`Catatan "${noteTitle}" berhasil dihapus!`);
          loadNotesList();
        });
    }
    
    // Hapus catatan (jika dihapus dari dalam editor)
    function deleteNote() {
      if (!currentTitle) return;
      const confirmDelete = confirm(`Yakin mau hapus catatan "${currentTitle}"?`);
      if (!confirmDelete) return;
      localStorage.removeItem(`note_${currentTitle}`);
      localStorage.removeItem(`note_image_${currentTitle}`);
      localStorage.removeItem("editorLocked_" + currentTitle);
      localStorage.removeItem("editorPassword_" + currentTitle);
      fetch(`http://localhost:3000/notes/${currentTitle}`, { method: "DELETE" })
        .then(() => {
          alert(`Catatan "${currentTitle}" berhasil dihapus!`);
          currentTitle = "";
          localStorage.removeItem("currentTitle");
          backToMenu();
        });
    }
    
    // Mendeteksi keyword untuk tooltip
    function detectTooltips(text) {
      let updatedText = text;
      const sortedTitles = pageTitles.slice().sort((a, b) => b.length - a.length);
      sortedTitles.forEach((title) => {
        if (title === currentTitle) return;
        const escapedTitle = title.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
        const regex = new RegExp(`\\b${escapedTitle}\\b`, "gi");
        updatedText = updatedText.replace(
          regex,
          `<a class="tooltip-keyword" data-keyword="${title}" href="#" onclick="loadNote('${title}'); return false;">${title}</a>`
        );
      });
      return updatedText;
    }
    
    // Inisialisasi tooltip dengan Tippy.js
    function initializeTooltips() {
      const tooltipElements = document.querySelectorAll(".tooltip-keyword");
      tippy(tooltipElements, {
        content(reference) {
          const keyword = reference.getAttribute("data-keyword");
          return getTooltipContent(keyword);
        },
        theme: "custom",
        allowHTML: true,
        arrow: true,
        placement: "left",
        interactive: true,
        maxWidth: "none",
        appendTo: "parent",
        interactiveBorder: 20,
        delay: [500, 200],
        popperOptions: {
          modifiers: [
            { name: "flip", options: { fallbackPlacements: ["top", "right", "bottom", "left"] } },
            { name: "preventOverflow", options: { boundary: "viewport", padding: 10 } },
            { name: "offset", options: { offset: [0, 10] } },
            { name: "positionFixed", options: { enabled: true } },
          ],
        },
        onShow(instance) {
          tippy.hideAll({ exclude: instance });
          if (instance.placement === "right") {
            const leftTooltip = instance.popper.querySelector(".left-tooltip");
            if (leftTooltip) { leftTooltip.classList.add("flipped"); }
          }
        },
      });
    }
    
    // Menghasilkan konten tooltip
    function getTooltipContent(keyword) {
      const imageData = localStorage.getItem(`note_image_${keyword}`) || "";
      const noteContent = localStorage.getItem(`note_${keyword}`) || "";
      if (!imageData) {
        return `<div class="tooltip-text">
                  <a href="#" class="tooltip-link" onclick="loadNote('${keyword}'); return false;">
                    ${noteContent}
                  </a>
                </div>`;
      }
      const ratioStored = localStorage.getItem(`note_image_ratio_${keyword}`);
      let useDefaultLayout = true;
      if (ratioStored) {
        const ratio = parseFloat(ratioStored);
        useDefaultLayout = ratio >= 1;
      }
      if (useDefaultLayout) {
        return `<div class="custom-tooltip">
                  <img src="${imageData}" alt="Image" style="width:100%; height:180px; object-fit:cover; object-position:center;">
                  <div class="tooltip-text">
                    <a href="#" class="tooltip-link" onclick="loadNote('${keyword}'); return false;">
                      ${noteContent}
                    </a>
                  </div>
                </div>`;
      } else {
        return `<div class="left-tooltip">
                  <div class="left-tooltip-image-container">
                    <img src="${imageData}" alt="Image" style="width:100%; height:100%; object-fit:cover; object-position:center;">
                  </div>
                  <div class="left-tooltip-text-container">
                    <div class="left-tooltip-text">
                      <a href="#" class="tooltip-link" onclick="loadNote('${keyword}'); return false;">
                        ${noteContent}
                      </a>
                    </div>
                  </div>
                </div>`;
      }
    }
    
    // ======================
    // FUNGSI LOCK/UNLOCK PER NOTE
    // ======================
    // Setiap note punya key lock: "editorLocked_[currentTitle]"
    // Dan password khusus: "editorPassword_[currentTitle]"
    
    function initializeEditorLock() {
      const lockKey = "editorLocked_" + currentTitle;
      let locked = localStorage.getItem(lockKey);
      if (locked === null) {
        // Default: terkunci
        locked = "true";
        localStorage.setItem(lockKey, locked);
      }
      updateEditorLockUI();
    }
    
    function updateEditorLockUI() {
      const lockKey = "editorLocked_" + currentTitle;
      const isLocked = localStorage.getItem(lockKey) === "true";
      const contentDiv = document.getElementById("content");
      const toggleLockButton = document.getElementById("toggleLockButton");
      if (isLocked) {
        contentDiv.setAttribute("contenteditable", "false");
        toggleLockButton.innerHTML = '<i class="fas fa-lock"></i>';
      } else {
        contentDiv.setAttribute("contenteditable", "true");
        toggleLockButton.innerHTML = '<i class="fas fa-unlock"></i>';
      }
    }
    
    function toggleLock() {
      const lockKey = "editorLocked_" + currentTitle;
      const passwordKey = "editorPassword_" + currentTitle;
      const isLocked = localStorage.getItem(lockKey) === "true";
      if (isLocked) {
        const storedPassword = localStorage.getItem(passwordKey);
        if (!storedPassword) {
          localStorage.setItem(lockKey, "false");
          updateEditorLockUI();
          alert("Editor untuk note ini dibuka (tidak ada password yang diset).");
          return;
        }
        const inputPassword = prompt("Masukkan password untuk membuka editor note ini:");
        if (inputPassword === storedPassword) {
          localStorage.setItem(lockKey, "false");
          updateEditorLockUI();
          alert("Editor untuk note ini berhasil dibuka!");
        } else {
          alert("Password salah!");
        }
      } else {
        localStorage.setItem(lockKey, "true");
        updateEditorLockUI();
        alert("Editor untuk note ini telah dikunci.");
      }
    }
    
    function setPassword() {
  const passwordKey = "editorPassword_" + currentTitle;
  const existingPassword = localStorage.getItem(passwordKey);
  if (existingPassword) {
    const currentInput = prompt("Masukkan password saat ini untuk note ini:");
    if (currentInput !== existingPassword) {
      alert("Password salah!");
      return;
    }
  }
  const newPassword = prompt("Masukkan password baru untuk note ini:");
  if (!newPassword) {
    alert("Password tidak boleh kosong!");
    return;
  }
  localStorage.setItem(passwordKey, newPassword);
  alert("Password untuk note ini berhasil diubah!");
}

    
    // ======================
    // MODAL SET PASSWORD (UNTUK NOTE BARU)
    // ======================
    function showPasswordModal() {
      const modal = document.getElementById("passwordModal");
      if (modal) { modal.style.display = "block"; }
    }
    
    function closePasswordModal() {
      const modal = document.getElementById("passwordModal");
      if (modal) { modal.style.display = "none"; }
    }
    
    function savePasswordModal() {
      const password = document.getElementById("passwordInput").value;
      if (!password) {
        alert("Password tidak boleh kosong!");
        return;
      }
      const passwordKey = "editorPassword_" + currentTitle;
      localStorage.setItem(passwordKey, password);
      alert("Password untuk note ini berhasil diset!");
      closePasswordModal();
    }
    
    function searchNotes() {
      let input = document.getElementById("searchInput").value.toLowerCase();
      let notes = document.getElementById("noteList").getElementsByTagName("li");
      for (let i = 0; i < notes.length; i++) {
        let noteTitle = notes[i].innerText.toLowerCase();
        notes[i].style.display = noteTitle.includes(input) ? "" : "none";
      }
    }
    
    let autoSaveTimeout;
    function scheduleAutoSave() {
      if (!isAutoSaveEnabled) return;
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(autoSaveNote, 2000);
    }
    
    document.getElementById("content").addEventListener("input", scheduleAutoSave);
    
    document.getElementById("noteTitle").addEventListener("input", function () {
      currentTitle = this.value.trim();
      localStorage.setItem("currentTitle", currentTitle);
      if (currentTitle !== "") { document.getElementById("titleWarning").style.display = "none"; }
      scheduleAutoSave();
    });
    
    function autoSaveNote() {
      if (currentTitle.trim() === "") return;
      const text = document.getElementById("content").innerText;
      console.log("Autosave - Text captured:", text);
      if (!isNewPage && originalTitle && currentTitle !== originalTitle) {
        localStorage.setItem(`note_${currentTitle}`, text);
        localStorage.setItem(`note_image_${currentTitle}`, currentImageData);
        const ratio = localStorage.getItem(`note_image_ratio_${originalTitle}`);
        if (ratio) {
          localStorage.setItem(`note_image_ratio_${currentTitle}`, ratio);
          localStorage.removeItem(`note_image_ratio_${originalTitle}`);
        }
        localStorage.removeItem(`note_${originalTitle}`);
        localStorage.removeItem(`note_image_${originalTitle}`);
        fetch(`http://localhost:3000/notes/${originalTitle}`, { method: "DELETE" })
          .then(() => {
            return fetch(`http://localhost:3000/notes/${currentTitle}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content: text, image: currentImageData })
            });
          })
          .then(() => {
            originalTitle = currentTitle;
            updateAutosaveUI(text);
          })
          .catch((err) => console.error("Autosave rename failed:", err));
      } else {
        localStorage.setItem(`note_${currentTitle}`, text);
        localStorage.setItem(`note_image_${currentTitle}`, currentImageData);
        fetch(`http://localhost:3000/notes/${currentTitle}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: text, image: currentImageData })
        })
          .then(() => { updateAutosaveUI(text); })
          .catch((err) => console.error("Autosave failed:", err));
      }
    }
    
    function updateAutosaveUI(text) {
      console.log("Autosave successful!");
      const updatedContent = detectTooltips(text);
      document.getElementById("content").innerHTML = updatedContent;
      initializeTooltips();
      localStorage.removeItem("draft_" + currentTitle);
    }
    
    function showTitleModal() {
      const modal = document.getElementById("titleModal");
      if (modal) { modal.style.display = "block"; }
      else { console.error("Modal dengan ID 'titleModal' tidak ditemukan!"); }
    }
    
    function closeTitleModal() {
      document.getElementById("titleModal").style.display = "none";
    }
    
    function saveTitleModal() {
  const newTitle = document.getElementById("modalTitleInput").value.trim();
  if (newTitle === "") {
    alert("Judul tidak boleh kosong!");
    return;
  }
  // **Penambahan: Validasi jika judul sudah ada**
  if (pageTitles.includes(newTitle)) {
    if (!confirm("Judul ini udah ada, apakah kamu mau replace?")) {
      document.getElementById("modalTitleInput").value = "";
      closeTitleModal();
      return;
    }
  }
  
  originalTitle = newTitle;
  currentTitle = newTitle;
  localStorage.setItem("currentTitle", newTitle);
  
  // Jika judul belum ada, tambahkan ke array. (Jika sudah ada dan user setuju, kita replace dengan mengganti judul lama.)
  let titles = JSON.parse(localStorage.getItem("pageTitles")) || [];
  if (!titles.includes(newTitle)) {
    titles.push(newTitle);
    localStorage.setItem("pageTitles", JSON.stringify(titles));
  }
  
  closeTitleModal();
  initEditorWithTitle(newTitle);
}


    
    function initEditorWithTitle(title) {
      document.getElementById("menu").style.display = "none";
      document.getElementById("editor").style.display = "block";
      const editorNoteTitle = document.querySelector("#editor #noteTitle");
      if (editorNoteTitle) { editorNoteTitle.value = title; }
      document.getElementById("titleWarning").style.display = "none";
      document.getElementById("content").innerText = "Tulis sesuatu...";
      document.getElementById("noteImage").value = "";
      document.getElementById("noteImagePreview").style.display = "none";
      currentImageData = "";
      isNewPage = true;
      // Inisialisasi lock untuk note baru (default terkunci)
      initializeEditorLock();
      // Jika note baru dan password belum diset, tampilkan modal set password
      setTimeout(function(){
        if (!localStorage.getItem("editorPassword_" + title)) {
          showPasswordModal();
        }
      }, 500);
    }

    function savePasswordModal() {
  const password = document.getElementById("passwordInput").value;
  if (!password) {
    alert("Password tidak boleh kosong!");
    return;
  }
  const passwordKey = "editorPassword_" + currentTitle;
  localStorage.setItem(passwordKey, password);
  // Set lock status menjadi "false" agar note langsung terbuka
  const lockKey = "editorLocked_" + currentTitle;
  localStorage.setItem(lockKey, "false");
  updateEditorLockUI();
  alert("Password untuk note ini berhasil diset dan editor langsung terbuka!");
  closePasswordModal();
}

// Modal Judul
function showTitleModal() {
  const modal = document.getElementById("titleModal");
  // Bersihkan input judul
  document.getElementById("modalTitleInput").value = "";
  if (modal) {
    modal.style.display = "block";
  } else {
    console.error("Modal dengan ID 'titleModal' tidak ditemukan!");
  }
}

function closeTitleModal() {
  // Reset input sebelum menutup modal
  document.getElementById("modalTitleInput").value = "";
  document.getElementById("titleModal").style.display = "none";
}

// Modal Set Password
function showPasswordModal() {
  const modal = document.getElementById("passwordModal");
  // Reset input password
  document.getElementById("passwordInput").value = "";
  if (modal) {
    modal.style.display = "block";
  }
}

function closeTitleModal() {
  document.getElementById("modalTitleInput").value = "";
  document.getElementById("titleModal").style.display = "none";
}

function closePasswordModal() {
  document.getElementById("passwordInput").value = "";
  document.getElementById("passwordModal").style.display = "none";
}



  </script>
</body>
</html>